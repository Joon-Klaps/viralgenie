# Output

!!! Warning "INCOMPLETE, YET TO BE WRITTEN"


## Introduction

This document describes the output produced by the pipeline. Most of the plots are taken from the MultiQC report, which summarises results at the end of the pipeline.

The directories listed below will be created in the results directory after the pipeline has finished. All paths are relative to the top-level results directory.

!!! Tip
    A global, partly, random prefix can be created using the argument `--prefix <string>`. The following string will then be used as a prefix to all output files.
    ```java
    "${prefix}_${date}_${pipeline.version}_${workflow.runName}"
    ```


## Pipeline overview

The pipeline is built using [Nextflow](https://www.nextflow.io/) and processes data using the following steps:

- [Preprocessing](#preprocessing)
    - [FastQC](#fastqc) - Read QC
    - [fastp](#fastp) or [Trimmomatic](#trimmomatic) - Adapter clipping
    - [BBduk](#bbduk) - Complexity filtering
    - [hostremoval-kraken2](#hostremoval-kraken2) - Contamination removal
-   [MultiQC](#multiqc) - Aggregate report describing results and QC from the whole pipeline
-   [Pipeline information](#pipeline-information) - Report metrics generated during the workflow execution

## Preprocessing

All output files of the preprocessing steps can be found in the directory `preprocessing/`.
### FastQC

???- abstract "Output files"
    -   `fastqc/{raw,trim,host}`
        -   `*_fastqc.html`: FastQC report containing quality metrics.
        -   `*_fastqc.zip`: Zip archive containing the FastQC report, tab-delimited data file and plot images.

[FastQC](http://www.bioinformatics.babraham.ac.uk/projects/fastqc/) gives general quality metrics about your sequenced reads. It provides information about the quality score distribution across your reads, per base sequence content (%A/T/G/C), adapter contamination and overrepresented sequences. For further reading and documentation see the [FastQC help pages](http://www.bioinformatics.babraham.ac.uk/projects/fastqc/Help/).

![MultiQC - FastQC sequence counts plot](images/mqc_fastqc_counts.png)

![MultiQC - FastQC mean quality scores plot](images/mqc_fastqc_quality.png)

![MultiQC - FastQC adapter content plot](images/mqc_fastqc_adapter.png)

!!! Tip
    The FastQC plots displayed in the MultiQC report shows _untrimmed_, _trimmed_ and _host filtered_ reads. Make sure to check the section titles for the correct set of reads.

### fastp

[fastp](https://github.com/OpenGene/fastp) is a FASTQ pre-processing tool for quality control, trimmming of adapters, quality filtering and other features.

???- abstract "Output files"

    - `fastp/`
        - `report/<sample_id>.*{html,json}`: report files in different formats.
        - `log/<sample_id>.*{html,json}`: log files.
        - `<sample_id>.fastp.fastq.gz`: file with the trimmed fastq reads.
        - `fail/<sample_id>.fail.fastq.gz`: file with reads that didn't suffice quality controls.

By default viralgenie will only provide the report and log files if fastp is selected. The trimmed reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'trimming'`. Similarly, the saving of the output reads can be enabled with `--save_trimmed_fail`.

### Trimmomatic
[Trimmomatic](http://www.usadellab.org/cms/?page=trimmomatic) is a FASTQ pre-processing tool for quality control, trimmming of adapters, quality filtering and other features.

???- abstract "Output files"

    - `trimmomatic/`
        - `*.fastq.gz`: file with the trimmed fastq reads.
        - `log/<sample_id>.*{html,txt,zip}`: log files generated by trimmomatic.

By default viralgenie will only provide the report and log files if Trimmomatic is selected. The trimmed reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'trimming'`.

### BBDuk

[BBDuk](https://jgi.doe.gov/data-and-tools/software-tools/bbtools/bb-tools-user-guide/bbduk-guide/) stands for Decontamination Using Kmers. BBDuk was developed to combine most common data-quality-related trimming, filtering, and masking operations into a single high-performance tool.

It is used in viralgenie for complexity filtering using different algorithms. This means that it will remove reads with low sequence diversity (e.g. mono- or dinucleotide repeats).

???- abstract "Output files"

    - `bbduk/`
        - `log/<sample_id>.bbduk.log`: log file containing filtering statistics
        - `<sample_id>.fastq.gz`: resulting FASTQ file without low-complexity reads

By default viralgenie will only provide the log files of bbduk. The filtered reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'complexity'`.


### Hostremoval-Kraken2

[Kraken2](https://ccb.jhu.edu/software/kraken2/) is a taxonomic sequence classifier that assigns taxonomic labels to DNA sequences. Kraken examines the k-mers within a query sequence and uses the information within those k-mers to query a database. That database maps -mers to the lowest common ancestor (LCA) of all genomes known to contain a given k-mer.

???- abstract "Output files"

    - `hostremoval-kraken2/`
        * `<sample_id>_kraken2_host_reports.txt`: A profile of the aligned reads to a given host contamination database.
        * `<sample_id>_kraken2_host.unclassified*.fastq.gz`: resulting FASTQ file with reads that don't have any matches to the given host contamination database.


By default viralgenie will only provide the log files of kraken2 which are visualised in [Multiqc](#multiqc). The filtered reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'host'`.

## Assembly & Polishing

The results of the assembly processes & polishing are stored in the directory `assembly/`.

Multiple intermediate files can be genarated during the assembly process, some of them might not always be interesting to have. For this reason, there is an option to save the intermediate files with the `--save_intermediate_polishing` argument which is by default off.

### Assemblers

Multiple assemblers [spades, trinity, megahit] can be used which have their results combined. Each assembler has its own directory in the `assembly/assemblers` directory, where there will be a subfolder for the contigs and the QC results from quast.

???- abstract "Output files"

    -   `assemblers/`
        -   `spades/<spades_mode>/`
            -   `contigs/<sample_id>_spades.fa.gz`: Contigs generated by SPAdes.
            -  `log/<sample_id>_spades.log`: Directory containing the log file of the spades run.
            -   `quast/<sample_id>_spades.tsv`: Directory containing the QUAST report.
        -   `trinity/`
            -   `contigs/<sample_id>_trinity.fa.gz`: Contigs generated by Trinity.
            -   `quast/<sample_id>_trinity.tsv`: Directory containing the QUAST report.
        -   `megahit/`
            -   `contigs/<sample_id>_megahit.fa.gz`: Contigs generated by Megahit.
            -   `quast/<sample_id>_megahit.tsv`: Directory containing the QUAST report.

Finally, the results of the assemblers are combined and stored in the `tools_combined/` directory.

???- abstract "Output files"

    - `assemblers`
        - `tools_combined/<sample_id>.combined.fa` : Contigs generated by combining the results of the assemblers.

### BLAST

[BLAST](https://blast.ncbi.nlm.nih.gov/Blast.cgi) is a sequence comparison tool that can be used to compare a query sequence against a database of sequences. In viralgenie, BLAST is used to compare the contigs generated by the assemblers to a database of viral sequences.

By default, viralgenie will only provide the BLAST results in a tabular format. It will have selected only for the top five hits and will also have filtered version where it will only include hits with an e-value of 0.01 or lower, a bitscore of 50 or higher and a alignment percentage of 0.80 or higher.

???- info "Column names"

    - qseqid
    - sseqid
    - stitle
    - pident
    - qlen
    - slen
    - length
    - mismatch
    - gapopen
    - qstart
    - qend
    - sstart
    - send
    - evalue
    - bitscore


???- abstract "Output files"

    - `polishing/`
        - `blast/<sample_id>_filter.tsv`: Filtered BLAST results in tabular format.
        - `intermediate/blast/filtered-sequences/<sample_id>_withref.fa`: Contigs with the blast hit sequence in a fasta file.
        - `intermediate/blast/hits/<sample_id>.txt`: unfiltered BLAST results in tabular format.

### Preclustering - Kaiju & Kraken2

[Kaiju](https://kaiju.binf.ku.dk/) is a program for sensitive taxonomic classification of high-throughput sequencing reads from metagenomic data. It is based on the Burrows-Wheeler transform and the lowest common ancestor algorithm.

[Kraken2](https://ccb.jhu.edu/software/kraken2/) is a taxonomic sequence classifier that assigns taxonomic labels to DNA sequences. Kraken examines the k-mers within a query sequence and uses the information within those k-mers to query a database. That database maps -mers to the lowest common ancestor (LCA) of all genomes known to contain a given k-mer.

???- abstract "Output files"

    - `polishing/intermediate/precluster`
        - `kaiju/<sample_id>_kaiju.tsv`: Raw output from Kaiju with taxonomic rank, read ID and taxonic ID
        - `kraken2/<sample_id>_kraken2_reports.txt`: A Kraken2 report that summarises the fraction abundance, taxonomic ID, number of Kmers, taxonomic path of all the hits in the Kraken2 run for a given sample. Will be 6 column rather than 8 if `--save_minimizers` specified.
        - `kraken2/<sample_id>_kraken2.classifiedreads.txt`: A list of read IDs and the hits each read had against the database for a given sample.
        - `merged_classifications/<sample_id>_merged.tsv`: Taxonomy merged based on the specified strategy with the columns being taxonomic rank, read ID and taxonic ID.
        - `sequences/<sample_id>/<sample_id>_taxid<taxonic ID>.fa`: Fasta file with the contigs that were classified to that specific taxonomic ID.



## MultiQC

???- abstract "Output files"
    -   `multiqc/`
        -   `multiqc_report.html`: a standalone HTML file that can be viewed in your web browser.
        -   `multiqc_data/`: directory containing parsed statistics from the different tools used in the pipeline.
        -   `multiqc_plots/`: directory containing static images from the report in various formats.

[MultiQC](http://multiqc.info) is a visualization tool that generates a single HTML report summarising all samples in your project. Most of the pipeline QC results are visualised in the report and further statistics are available in the report data directory.

Results generated by MultiQC collate pipeline QC from supported tools e.g. FastQC. The pipeline has special steps which also allow the software versions to be reported in the MultiQC output for future traceability. For more information about how to use MultiQC reports, see <http://multiqc.info>.

## Pipeline information

???- abstract "Output files"

    -   `pipeline_info/`
        -   Reports generated by Nextflow: `execution_report.html`, `execution_timeline.html`, `execution_trace.txt` and `pipeline_dag.dot`/`pipeline_dag.svg`.
        -   Reports generated by the pipeline: `pipeline_report.html`, `pipeline_report.txt` and `software_versions.yml`. The `pipeline_report*` files will only be present if the `--email` / `--email_on_fail` parameter's are used when running the pipeline.
        -   Reformatted samplesheet files used as input to the pipeline: `samplesheet.valid.csv`.
        -   Parameters used by the pipeline run: `params.json`.

[Nextflow](https://www.nextflow.io/docs/latest/tracing.html) provides excellent functionality for generating various reports relevant to the running and execution of the pipeline. This will allow you to troubleshoot errors with the running of the pipeline, and also provide you with other information such as launch commands, run times and resource usage.
