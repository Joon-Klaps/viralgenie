# Output

!!! Warning "INCOMPLETE, YET TO BE WRITTEN"


## Introduction

This document describes the output produced by the pipeline. Most of the plots are taken from the MultiQC report, which summarises results at the end of the pipeline.

The directories listed below will be created in the results directory after the pipeline has finished. All paths are relative to the top-level results directory.

!!! Tip
    A global, partly, random prefix can be created using the argument `--prefix <string>`. The following string will then be used as a prefix to all output files.
    ```java
    "${prefix}_${date}_${pipeline.version}_${workflow.runName}"
    ```


## Pipeline overview

The pipeline is built using [Nextflow](https://www.nextflow.io/) and processes data using the following steps:

- [Preprocessing](#preprocessing)
    - [FastQC](#fastqc) - Read QC
    - [fastp](#fastp) or [Trimmomatic](#trimmomatic) - Adapter clipping
    - [BBduk](#bbduk) - Complexity filtering
    - [hostremoval-kraken2](#hostremoval-kraken2) - Contamination removal
-   [MultiQC](#multiqc) - Aggregate report describing results and QC from the whole pipeline
-   [Pipeline information](#pipeline-information) - Report metrics generated during the workflow execution

## Preprocessing

All output files of the preprocessing steps can be found in the directory `preprocessing/`.
### FastQC

???- abstract "Output files"
    -   `fastqc/{raw,trim,host}`
        -   `*_fastqc.html`: FastQC report containing quality metrics.
        -   `*_fastqc.zip`: Zip archive containing the FastQC report, tab-delimited data file and plot images.

[FastQC](http://www.bioinformatics.babraham.ac.uk/projects/fastqc/) gives general quality metrics about your sequenced reads. It provides information about the quality score distribution across your reads, per base sequence content (%A/T/G/C), adapter contamination and overrepresented sequences. For further reading and documentation see the [FastQC help pages](http://www.bioinformatics.babraham.ac.uk/projects/fastqc/Help/).

![MultiQC - FastQC sequence counts plot](images/mqc_fastqc_counts.png)

![MultiQC - FastQC mean quality scores plot](images/mqc_fastqc_quality.png)

![MultiQC - FastQC adapter content plot](images/mqc_fastqc_adapter.png)

!!! Tip
    The FastQC plots displayed in the MultiQC report shows _untrimmed_, _trimmed_ and _host filtered_ reads. Make sure to check the section titles for the correct set of reads.

### fastp

[fastp](https://github.com/OpenGene/fastp) is a FASTQ pre-processing tool for quality control, trimmming of adapters, quality filtering and other features.

???- abstract "Output files"

    - `fastp/`
        - `report/<sample_id>.*{html,json}`: report files in different formats.
        - `log/<sample_id>.*{html,json}`: log files.
        - `<sample_id>.fastp.fastq.gz`: file with the trimmed fastq reads.
        - `fail/<sample_id>.fail.fastq.gz`: file with reads that didn't suffice quality controls.

By default viralgenie will only provide the report and log files if fastp is selected. The trimmed reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'trimming'`. Similarly, the saving of the output reads can be enabled with `--save_trimmed_fail`.

### Trimmomatic
[Trimmomatic](http://www.usadellab.org/cms/?page=trimmomatic) is a FASTQ pre-processing tool for quality control, trimmming of adapters, quality filtering and other features.

???- abstract "Output files"

    - `trimmomatic/`
        - `*.fastq.gz`: file with the trimmed fastq reads.
        - `log/<sample_id>.*{html,txt,zip}`: log files generated by trimmomatic.

By default viralgenie will only provide the report and log files if Trimmomatic is selected. The trimmed reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'trimming'`.

### BBDuk

[BBDuk](https://jgi.doe.gov/data-and-tools/software-tools/bbtools/bb-tools-user-guide/bbduk-guide/) stands for Decontamination Using Kmers. BBDuk was developed to combine most common data-quality-related trimming, filtering, and masking operations into a single high-performance tool.

It is used in viralgenie for complexity filtering using different algorithms. This means that it will remove reads with low sequence diversity (e.g. mono- or dinucleotide repeats).

???- abstract "Output files"

    - `bbduk/`
        - `log/<sample_id>.bbduk.log`: log file containing filtering statistics
        - `<sample_id>.fastq.gz`: resulting FASTQ file without low-complexity reads

By default viralgenie will only provide the log files of bbduk. The filtered reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'complexity'`.


### Hostremoval-Kraken2

[Kraken2](https://ccb.jhu.edu/software/kraken2/) is a taxonomic sequence classifier that assigns taxonomic labels to DNA sequences. Kraken examines the k-mers within a query sequence and uses the information within those k-mers to query a database. That database maps -mers to the lowest common ancestor (LCA) of all genomes known to contain a given k-mer.

???- abstract "Output files"

    - `hostremoval-kraken2/`
        * `<sample_id>_kraken2_host_reports.txt`: A profile of the aligned reads to a given host contamination database.
        * `<sample_id>_kraken2_host.unclassified*.fastq.gz`: resulting FASTQ file with reads that don't have any matches to the given host contamination database.


By default viralgenie will only provide the log files of kraken2 which are visualised in [Multiqc](#multiqc). The filtered reads can be saved by specifying `--save_intermediate_reads` or `--save_final_reads 'host'`.

## MultiQC

???- abstract "Output files"
    -   `multiqc/`
        -   `multiqc_report.html`: a standalone HTML file that can be viewed in your web browser.
        -   `multiqc_data/`: directory containing parsed statistics from the different tools used in the pipeline.
        -   `multiqc_plots/`: directory containing static images from the report in various formats.

[MultiQC](http://multiqc.info) is a visualization tool that generates a single HTML report summarising all samples in your project. Most of the pipeline QC results are visualised in the report and further statistics are available in the report data directory.

Results generated by MultiQC collate pipeline QC from supported tools e.g. FastQC. The pipeline has special steps which also allow the software versions to be reported in the MultiQC output for future traceability. For more information about how to use MultiQC reports, see <http://multiqc.info>.

## Pipeline information

???- abstract "Output files"

    -   `pipeline_info/`
        -   Reports generated by Nextflow: `execution_report.html`, `execution_timeline.html`, `execution_trace.txt` and `pipeline_dag.dot`/`pipeline_dag.svg`.
        -   Reports generated by the pipeline: `pipeline_report.html`, `pipeline_report.txt` and `software_versions.yml`. The `pipeline_report*` files will only be present if the `--email` / `--email_on_fail` parameter's are used when running the pipeline.
        -   Reformatted samplesheet files used as input to the pipeline: `samplesheet.valid.csv`.
        -   Parameters used by the pipeline run: `params.json`.

[Nextflow](https://www.nextflow.io/docs/latest/tracing.html) provides excellent functionality for generating various reports relevant to the running and execution of the pipeline. This will allow you to troubleshoot errors with the running of the pipeline, and also provide you with other information such as launch commands, run times and resource usage.
